<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Generator - Production Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
    <style>
        .generator-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .input-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .topic-input {
            background: var(--darker-color);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            border-radius: 0.5rem;
            padding: 1rem;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .topic-input:focus {
            background: var(--darker-color);
            border-color: var(--primary-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(249, 115, 22, 0.25);
            outline: none;
        }

        .control-group {
            background: var(--darker-color);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .control-label {
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .style-selector, .platform-selector {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-primary);
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-weight: 500;
        }

        .style-selector:focus, .platform-selector:focus {
            background: var(--card-bg);
            border-color: var(--primary-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(249, 115, 22, 0.25);
        }

        .quantity-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--darker-color);
            outline: none;
            -webkit-appearance: none;
            margin: 1rem 0;
        }

        .quantity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(249, 115, 22, 0.4);
        }

        .quantity-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(249, 115, 22, 0.4);
        }

        .quantity-display {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
            display: inline-block;
        }

        .generate-btn {
            background: linear-gradient(135deg, var(--primary-color), #ea580c);
            border: none;
            color: white;
            padding: 1rem 3rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(249, 115, 22, 0.3);
            width: 100%;
            margin-top: 1rem;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(249, 115, 22, 0.4);
            background: linear-gradient(135deg, #ea580c, #dc2626);
        }

        .generate-btn:disabled {
            background: var(--secondary-color);
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }

        .output-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 1rem;
            padding: 2rem;
            min-height: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .content-card {
            background: var(--darker-color);
            border: 1px solid var(--card-border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .content-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 20px rgba(249, 115, 22, 0.2);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--card-border);
        }

        .content-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .content-body {
            color: var(--text-primary);
            line-height: 1.7;
            white-space: pre-wrap;
            font-size: 0.95rem;
        }

        .copy-btn {
            background: var(--primary-color);
            border: none;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .copy-btn:hover {
            background: #ea580c;
            transform: translateY(-1px);
        }

        .copy-btn.copied {
            background: var(--success-color);
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading-spinner.active {
            display: block;
        }

        .stats-bar {
            background: var(--darker-color);
            border: 1px solid var(--card-border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            color: var(--primary-color);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .generation-info {
            background: rgba(249, 115, 22, 0.1);
            border: 1px solid var(--primary-color);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .generator-container {
                padding: 1rem;
            }

            .input-section, .output-section {
                padding: 1.5rem;
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .stats-bar {
                flex-direction: column;
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-rocket"></i> Content Dashboard</h4>
        </div>
        <nav class="nav flex-column">
            <a href="{{ url_for('dashboard') }}" class="nav-link">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="{{ url_for('topics') }}" class="nav-link">
                <i class="fas fa-lightbulb"></i> Topics
            </a>
            <a href="{{ url_for('content_generator') }}" class="nav-link active">
                <i class="fas fa-magic"></i> Generator
            </a>
            <a href="/generated-posts" class="nav-link">
                <i class="fas fa-file-alt"></i> Generated Posts
            </a>
            <a href="{{ url_for('analytics') }}" class="nav-link">
                <i class="fas fa-chart-line"></i> Analytics
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-header">
            <h2><i class="fas fa-magic"></i> Content Generator</h2>
            <p class="text-muted mb-0">Generate high-quality content with AI assistance</p>
        </div>

        <div class="generator-container">
            <!-- Input Section -->
            <div class="input-section">
                <h4 class="mb-4"><i class="fas fa-edit"></i> Content Settings</h4>

                <div class="mb-4">
                    <label class="control-label">Select Topic or Create New</label>
                    <select id="topicSelect" class="form-select style-selector mb-3">
                        <option value="">-- Choose an existing topic --</option>
                    </select>

                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="text-muted">OR</span>
                    </div>

                    <textarea
                        id="topicInput"
                        class="form-control topic-input"
                        rows="2"
                        placeholder="Create a new topic here..."
                    ></textarea>
                    <small class="text-muted">Select an existing topic above or create a new one. Selected topics will use their predefined style and key points.</small>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="control-group">
                            <label class="control-label">Platform</label>
                            <select id="platformSelect" class="form-select platform-selector">
                                <option value="linkedin">LinkedIn</option>
                                <option value="twitter">Twitter</option>
                                <option value="instagram">Instagram</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="control-group">
                            <label class="control-label">Content Style</label>
                            <select id="styleSelect" class="form-select style-selector">
                                <option value="educational">Educational</option>
                                <option value="case_study">Case Study</option>
                                <option value="story">Story</option>
                                <option value="insight">Insight</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="control-group">
                            <label class="control-label">Number of Posts</label>
                            <div class="d-flex align-items-center gap-3">
                                <input type="range" id="quantitySlider" class="quantity-slider" min="1" max="10" value="5">
                                <div class="quantity-display" id="quantityDisplay">5</div>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="generateBtn" class="generate-btn">
                    <i class="fas fa-magic"></i> Generate Content
                </button>
            </div>

            <!-- Loading State -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: var(--primary-color);" role="status">
                    <span class="visually-hidden">Generating...</span>
                </div>
                <h5>Generating Content...</h5>
                <p class="text-muted">This usually takes 10-30 seconds depending on the number of posts.</p>
            </div>

            <!-- Generation Info -->
            <div class="generation-info" id="generationInfo" style="display: none;">
                <i class="fas fa-info-circle"></i> <span id="generationInfoText"></span>
            </div>

            <!-- Output Section -->
            <div class="output-section">
                <h4 class="mb-4"><i class="fas fa-file-alt"></i> Generated Content</h4>

                <!-- Stats Bar -->
                <div class="stats-bar" id="statsBar" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-value" id="totalPosts">0</div>
                        <div class="stat-label">Total Posts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="cachedPosts">0</div>
                        <div class="stat-label">Cached</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="generationTime">0s</div>
                        <div class="stat-label">Generation Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="successRate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>

                <!-- Content Display Area -->
                <div id="contentDisplay">
                    <div class="empty-state">
                        <i class="fas fa-magic"></i>
                        <h5>Ready to Generate Content</h5>
                        <p>Configure your settings above and click "Generate Content" to start creating high-quality posts.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM Elements
        const topicInput = document.getElementById('topicInput');
        const platformSelect = document.getElementById('platformSelect');
        const styleSelect = document.getElementById('styleSelect');
        const quantitySlider = document.getElementById('quantitySlider');
        const quantityDisplay = document.getElementById('quantityDisplay');
        const generateBtn = document.getElementById('generateBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const contentDisplay = document.getElementById('contentDisplay');
        const statsBar = document.getElementById('statsBar');
        const generationInfo = document.getElementById('generationInfo');
        const generationInfoText = document.getElementById('generationInfoText');

        // Update quantity display
        quantitySlider.addEventListener('input', function() {
            quantityDisplay.textContent = this.value;
        });

        // Copy to clipboard functionality
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Load topics from API
        async function loadTopics() {
            try {
                const response = await fetch('/api/topics');
                const topics = await response.json();

                const topicSelect = document.getElementById('topicSelect');
                topicSelect.innerHTML = '<option value="">-- Choose an existing topic --</option>';

                topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(topic);
                    option.textContent = `${topic.topic} (${topic.style})`;
                    topicSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading topics:', error);
            }
        }

        // Handle topic selection
        document.getElementById('topicSelect').addEventListener('change', function() {
            const selectedValue = this.value;
            const topicInput = document.getElementById('topicInput');
            const styleSelect = document.getElementById('styleSelect');

            if (selectedValue) {
                const topic = JSON.parse(selectedValue);
                topicInput.value = topic.topic;
                styleSelect.value = topic.style;
                topicInput.disabled = true;
                styleSelect.disabled = true;

                // Show topic info
                const topicInfo = document.getElementById('topicInfo');
                if (topicInfo) {
                    topicInfo.style.display = 'block';
                    document.getElementById('topicPoints').textContent = topic.points.slice(0, 2).join(' • ');
                } else {
                    const infoDiv = document.createElement('div');
                    infoDiv.id = 'topicInfo';
                    infoDiv.className = 'alert alert-info mt-2';
                    infoDiv.innerHTML = `<small><strong>Key Points:</strong> <span id="topicPoints">${topic.points.slice(0, 2).join(' • ')}</span></small>`;
                    topicInput.parentNode.appendChild(infoDiv);
                }
            } else {
                topicInput.disabled = false;
                styleSelect.disabled = false;
                topicInput.value = '';
                const topicInfo = document.getElementById('topicInfo');
                if (topicInfo) {
                    topicInfo.style.display = 'none';
                }
            }
        });

        // Generate content
        generateBtn.addEventListener('click', async function() {
            const selectedTopic = document.getElementById('topicSelect').value;
            const customTopic = topicInput.value.trim();

            let topic, style;

            if (selectedTopic) {
                // Use selected topic
                const topicData = JSON.parse(selectedTopic);
                topic = topicData.topic;
                style = topicData.style;
            } else if (customTopic) {
                // Use custom topic
                topic = customTopic;
                style = styleSelect.value;
            } else {
                alert('Please select an existing topic or enter a new one.');
                return;
            }

            const platform = platformSelect.value;
            const numPosts = parseInt(quantitySlider.value);

            // Show loading state
            generateBtn.disabled = true;
            loadingSpinner.classList.add('active');
            contentDisplay.style.display = 'none';
            statsBar.style.display = 'none';
            generationInfo.style.display = 'block';
            generationInfoText.textContent = `Generating ${numPosts} ${style} ${platform} posts about "${topic}"...`;

            const startTime = Date.now();

            try {
                const response = await fetch('/api/generate/content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: topic,
                        platform: platform,
                        style: style,
                        num_posts: numPosts,
                        use_fast: true
                    })
                });

                const result = await response.json();
                const endTime = Date.now();
                const generationTime = ((endTime - startTime) / 1000).toFixed(1);

                if (result.success) {
                    generationInfoText.textContent = result.message;

                    // Wait a moment then fetch the generated content
                    setTimeout(async () => {
                        await fetchLatestContent(platform, generationTime);
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Generation failed');
                }
            } catch (error) {
                generationInfoText.textContent = `Error: ${error.message}`;
                generateBtn.disabled = false;
                loadingSpinner.classList.remove('active');
            }
        });

        // Fetch latest generated content
        async function fetchLatestContent(platform, generationTime) {
            try {
                const response = await fetch('/api/generator/latest');
                const result = await response.json();

                if (result.success && result.content) {
                    displayContent(result.content, platform, generationTime);
                } else {
                    throw new Error('No content found');
                }
            } catch (error) {
                generationInfoText.textContent = `Error loading content: ${error.message}`;
            } finally {
                generateBtn.disabled = false;
                loadingSpinner.classList.remove('active');
            }
        }

        // Copy to clipboard function
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        // Display generated content
        function displayContent(content, platform, generationTime) {
            console.log('Displaying content:', { content, platform, generationTime }); // Debug log

            const posts = Array.isArray(content) ? content : [content];
            console.log('Posts to display:', posts.length);

            if (posts.length === 0 || !posts[0]) {
                console.log('No posts to display');
                contentDisplay.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h5>No Content Available</h5>
                        <p>Try generating some new content or check if there were any errors.</p>
                    </div>
                `;
                statsBar.style.display = 'none';
                generationInfo.style.display = 'block';
                generationInfoText.textContent = 'No content found. Generate new content to get started.';
                return;
            }

            // Update stats
            const totalPosts = posts.length;
            const cachedPosts = posts.filter(p => p.cached).length;
            const successRate = totalPosts > 0 ? ((totalPosts / totalPosts) * 100).toFixed(0) : 0;

            document.getElementById('totalPosts').textContent = totalPosts;
            document.getElementById('cachedPosts').textContent = cachedPosts;
            document.getElementById('generationTime').textContent = `${generationTime}s`;
            document.getElementById('successRate').textContent = `${successRate}%`;

            // Generate HTML for content
            let contentHTML = '';
            posts.forEach((post, index) => {
                console.log(`Processing post ${index + 1}:`, post.topic); // Debug log

                const postNumber = post.post_number || index + 1;
                const topic = post.topic || 'Generated Content';
                const content = post.content || '';
                const style = post.prompt_type || post.style || 'educational';
                const cached = post.cached || false;

                contentHTML += `
                    <div class="content-card">
                        <div class="content-header">
                            <div class="content-meta">
                                <span class="badge bg-primary">Post ${postNumber}</span>
                                <span class="badge platform-${platform}">${platform.charAt(0).toUpperCase() + platform.slice(1)}</span>
                                <span class="badge bg-secondary">${style.charAt(0).toUpperCase() + style.slice(1)}</span>
                                ${cached ? '<span class="badge bg-success"><i class="fas fa-bolt"></i> Cached</span>' : ''}
                            </div>
                            <button class="copy-btn" onclick="copyToClipboard(\`${content.replace(/`/g, '\\`')}\`, this)">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <div class="content-body">${content}</div>
                    </div>
                `;
            });

            console.log('Setting content HTML, length:', contentHTML.length); // Debug log
            contentDisplay.innerHTML = contentHTML;
            statsBar.style.display = 'flex';
            generationInfo.style.display = 'none';
            contentDisplay.style.display = 'block';
        }

        // Load latest content on page load
        window.addEventListener('load', async function() {
            // Load topics
            await loadTopics();

            // Load previous content
            try {
                const response = await fetch('/api/generator/latest');
                const result = await response.json();

                console.log('Latest content result:', result); // Debug log

                if (result.success && result.content) {
                    displayContent(result.content, result.source || 'linkedin', '0');
                } else {
                    console.log('No content found or unsuccessful response');
                }
            } catch (error) {
                console.log('No previous content found:', error);
            }
        });
    </script>
</body>
</html>